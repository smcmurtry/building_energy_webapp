<!DOCTYPE html>
<html>
<title>Public Building Energy Consumption in Ontario</title>
<link rel="stylesheet" href="jquery-ui-v2.css">
<link rel="stylesheet" href="jquery.dataTables.css">

<style>
body {
  font: 18px helvetica neue;
  padding:0px;
  background-color: #f6f6f6;
}

#search-bar { 
  width: 910px; 
  text-align:left;
  color: black;
}
#go-button {
  color: black;
}

#radio label { 
  padding: 0px;
  border-color: grey;
  top: 0px;
}

#search-by {
  font-size: 20px;
  padding: .4em 0em;
  width:150px;
  float: left;
}

.ui-state-default {
  color:lightgrey;
}

.ui-state-active {
  color:black;
}

.ui-widget {
  text-align:left;
}

#search-div, #footnote, #title, #intro, #text-and-radio {
  width:1000px;
  margin:0px auto;
  padding:15px;
  text-align:left;
}

#footnote {margin-top: 50px;}

#map-and-list {
  width: 1000px;
  height: 500px;
  overflow: hidden;
  margin: 0px auto;
  margin-bottom: 50px;
}

#map_canvas {
  width: 50%;
  height: 100%;
  float: right;
}

#results-container {
  background-color: white;
  /*white-space: nowrap; causes text not to wrap */
  height: 100%;
  width: 49%; 
  float: left;
  text-align: left;
}

.left-report tr > td {
  padding-bottom: 10px;
}

.right-report tr > td {
  padding-bottom: 0px;
}

.report, 
.right-report, .left-report{
  height: 300px;
}

.right-report, .left-report{
  background-color: white;
}

.big-text {
  font-size: 40px;
}

.small-text {
  font-size: 14px;
}
.right-report {
  width:29%;
  text-align:right;
  float:right;
}

.left-report {
 width:70%; 
 float:left;
}

.report {
  width:1000px;
  margin:0 auto;
  padding-bottom: 100px;
}

.axis text, .x.label, .y.label {
  font: 10px sans-serif;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.y.axis line {
  stroke: #000; 
}

.x.axis path, .y.axis path {
  display: none;
}

.bar {
  fill: grey;
  fill-opacity: 1.;
}

label {
  position: absolute;
  top: 10px;
  right: 10px;
}

.chart {float: right;}

</style>

<script src="d3.min.js"></script>
<script src="//code.jquery.com/jquery-1.10.2.js"></script>
<script src="//code.jquery.com/ui/1.11.3/jquery-ui.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&libraries=visualization"></script>
<script src="jquery.dataTables.min.js"></script>

<script>
// <script src="//code.jquery.com/ui/1.11.3/jquery-ui.js">
// <script src="jquery-ui-1.11.4.custom/jquery-ui.js">
// from http://stackoverflow.com/questions/19640055/multiple-markers-google-map-api-v3-from-array-of-addresses-and-avoid-over-query

// initialize radio buttons
$(function() {
  $( "#radio" ).buttonset();
});


var infowindow = null;
initialize_map();
comma_format = d3.format("0,000");
zero_format_int = d3.format("06d");
zero_format_float = d3.format('07.0r');

function initialize_autocomplete(searchable_array) {
  $(function() {$( "#search-bar" ).autocomplete({ source: searchable_array }); });
  $('.default-value').each( function () {
  var $t = $(this),
  default_value = this.value;
  $t.css('color', '#929292');
  $t.focus(function () {
   if (this.value == default_value) {
     this.value = '';
     $t.css('color', 'black');
   }
  });
  $t.blur(function () {
   if ($.trim(this.value) == '') {
     $t.css('color', '#929292');
     this.value = default_value;
   }
  });
  });
}

d3.csv("dim_city.csv", function(DimCity) {
  d3.csv("dim_organization.csv", function(DimOrganization) { 
    d3.csv("dim_operation_type.csv", function(DimOperationType) {
      var org_array = [];
      for (var i = DimOrganization.length - 1; i >= 0; i--) {
        org_array.push(DimOrganization[i].organization);
      };

      var op_types = [];
      for (var i = DimOperationType.length - 1; i >= 0; i--) {
        op_types.push(DimOperationType[i].operation_type);
      };

      initialize_autocomplete(org_array);

      // add listeners to the radio button
      $(function() {
        $( "input[id=radio1]" )
        .button()
        .click(function( event ) { initialize_autocomplete(org_array); })
      });

      $(function() {
        $( "input[id=radio2]" )
        .button()
        .click(function( event ) { initialize_autocomplete(op_types); })
      });

      d3.csv("master_short.csv", function(Master) {
        var dists = get_dists(Master);
        $(function() {
          $( "input[id=go-button]" )
          .button()
          .click(function( event ) {
            $('.report').remove();
            initialize_map();
            $("#results-table tbody").empty();
            event.preventDefault();
            var nameInput = document.getElementById('search-bar');
            
            var dim_organization_row = DimOrganization.filter( function( obj ) { return obj.organization == nameInput.value; });
            var dim_op_type_row = DimOperationType.filter( function( obj ) { return obj.operation_type == nameInput.value; });
            var rows;
            var org_mode;

            if (dim_organization_row.length > 0) {
              console.log('1');
              var dim_org_id = dim_organization_row[0].dim_organization; // should be only one result
              rows = Master.filter( function( obj ) { return obj.dim_organization == dim_org_id; });
              org_mode = true;
            }
            if (dim_op_type_row.length > 0) {
              console.log('2');
              var dim_op_type_id = dim_op_type_row[0].dim_operation_type; // should be only one result
              rows = Master.filter( function( obj ) { return obj.dim_operation_type == dim_op_type_id; });
              org_mode = false;
            }
            //var org = nameInput.value;
            //var dim_organization_row = DimOrganization.filter( function( obj ) { return obj.organization == org; });
            //var dim_org_id = dim_organization_row[0].dim_organization; // should be only one result
            //var rows = Master.filter( function( obj ) { return obj.dim_organization == dim_org_id; });
            console.log('3');
            do_everything(rows, Master, DimCity, DimOperationType, DimOrganization, dists, org_mode);
        });
});
});
});
});
});

function initialize_map(){

  $(document).ready(function () {
    var myOptions = {
      zoom: 5,
      center: new google.maps.LatLng(49.3,-85.0),
      mapTypeId: 'terrain'
    };
    var map = new google.maps.Map($('#map_canvas')[0], myOptions);

    $('#results-table').dataTable( {
        scrollY:        "400px", // this doesn't include the header
        //scrollX:        true,
        paging:         false,
        retrieve:       true,
        defaultContent: '',
        sDom: 'lrtp', // removed i=length statement and f=search box
        columns: [
            { data: { _: 'org_rank.display', sort: 'org_rank.rank' } }, 
            { data: { _: 'similar_rank.display', sort: 'similar_rank.rank' } },
            { data: "name"} ]
    } );
  });

}

function do_everything(rows, Master, DimCity, DimOperationType, DimOrganization, dists, org_mode) {
  console.log('4');

  $(document).ready(function () {
    $('#map_canvas').empty();
    $("#results-table tbody").empty();
    $('#results-table').DataTable().clear().draw();
    console.log('5');

    var myOptions = {
      zoom: 1,
      center: new google.maps.LatLng(0, 0),
      mapTypeId: 'terrain'
    };
    var map = new google.maps.Map($('#map_canvas')[0], myOptions);
    var latlngbounds = new google.maps.LatLngBounds();

    infowindow = new google.maps.InfoWindow({
      content: "holding..."
    });

    var pinImage = new google.maps.MarkerImage('grey_pin.png'); 
    var markers = {};
    

    //console.log('6');

    for (var x = 0; x < rows.length; x++) {
      var r = rows[x]
      var operation_type_row = DimOperationType.filter(function( obj ) { return obj.dim_operation_type == r.dim_operation_type; })[0];
      var organization_row = DimOrganization.filter(function( obj ) { return obj.dim_organization == r.dim_organization; })[0];
      var n_org_buildings = organization_row.n_buildings;
      var n_op_type_buildings = operation_type_row.n_buildings;

      //console.log('7');

      var sensorId = r.index;

      $('#results-table').dataTable().fnAddData( [
        { "DT_RowId": sensorId + "VisibleCheckbox", 
          "org_rank": {
            "display": comma_format(r.org_rank) + ' of ' + comma_format(n_org_buildings), 
            "rank": zero_format_int(r.org_rank) },
          "similar_rank": {
            "display": comma_format(r.op_type_rank) + ' of ' + comma_format(n_op_type_buildings), 
            "rank": zero_format_int(d3.round(10000 * r.op_type_rank / n_op_type_buildings )) },
          "name": r.operation_name } ],
      false);
      //console.log('8');

      var latlng = new google.maps.LatLng(r.lat, r.lng);
      latlngbounds.extend(latlng);
      var marker = new google.maps.Marker({
        position: latlng,
        map: map,
        title: r.operation_name,
        icon: pinImage,
        zIndex: 1,
        index: r.index,
        opacity: 0.5
      });
      markers[sensorId+"VisibleCheckbox"] = marker;

      google.maps.event.addListener(marker, 'click', function(e) {
        console.log('9');

        $("#"+this.index+"VisibleCheckbox").toggleClass('selected');
        infowindow.setContent(this.title);
        infowindow.open(map, this);
        if (this.zIndex == 1) {

          //$(".dataTables_scrollBody").scrollTop( $("#" + this.index + "VisibleCheckbox").offset().top - 400 );//- $(".dataTables_scrollBody").height() );

          // scroll to checked box in list #results-container*
          /*
          var container = $('#dataTables_scrollBody'),
          scrollTo = $("#"+this.index+"VisibleCheckbox");
          container.scrollTop(
              scrollTo.offset().top - container.offset().top + container.scrollTop() - 20 // 20 is an offset so that the entry is not hidden at the very top
              );
          */

          on_select(this, Master, DimCity, DimOperationType, dists);
        } else {
          on_deselect(this);
        }
      });
    }

    // draw the datatable
    $('#results-table').dataTable().fnDraw();

    map.setCenter(latlngbounds.getCenter());
    map.fitBounds(latlngbounds); 
    console.log('10');

  // listen for results click
    $('#results-table tbody').on( 'click', 'tr', function () {
        $(this).toggleClass('selected');
        // update map and stuff
        //console.log(this);
        sId = $(this)[0].id;
        //console.log(sId);
        m = markers[sId];
        if (m.zIndex == 1) {
          on_select(m, Master, DimCity, DimOperationType, dists);
        } else {
          on_deselect(m);
        } 
    } );
  });
}

function on_select(marker, Master, DimCity, DimOperationType, dists) {
  //if zIndex == 2, selected=True
  marker.setIcon("green_pin.png");
  marker.setZIndex(2);
  marker.setOpacity(1.0);
  $("#"+marker.index+"VisibleCheckbox").prop('checked', true);
  var row_index = 1*marker.index;
  var row = Master.filter(function( obj ) { return obj.index == row_index; })[0];
  var city_row = DimCity.filter(function( obj ) { return obj.dim_City == row.dim_City; })[0];
  var operation_type_row = DimOperationType.filter(function( obj ) { return obj.dim_operation_type == row.dim_operation_type; })[0];
  var dist = dists[row.dim_operation_type];
  generateReport(row, city_row, operation_type_row, dist);
};

function on_deselect(marker) {
  marker.setIcon("grey_pin.png");
  marker.setZIndex(1);
  $("#"+marker.index+"VisibleCheckbox").prop('checked', false);
  marker.setOpacity(0.5)
  $( "#report-" + marker.index ).remove();
};

function generateReport(row, city_row, operation_type_row, clean_dist) {
  $( "#container" ).append( '<div class="report" id="report-' + row.index + '"></div>' );
  $( "#report-" + row.index ).append(  '<h2>' + row.operation_name + '</h2>' );
  $( "#report-" + row.index ).append(  '<div class="left-report"></div>' );
  $( "#report-" + row.index ).append(  '<div class="right-report"></div>' );
  $( "#report-" + row.index + "> .left-report").append( get_table(row, city_row, operation_type_row) );
  $( "#report-" + row.index + "> .right-report").append( get_pct_rank(row, operation_type_row) )
  $( "#report-" + row.index + "> .right-report").append( '<div id="chart-' + row.index + '" class="chart"></div>' )
  plot_hist(clean_dist, row.en_intensity_ekWh_sqft, '#chart-' + row.index);
};


function get_table(row, city_row, operation_type_row) {

  var table = '<table class="report-table">'
  table += '<col width="40%">'
  table += '<col width="60%">'

  table += '<tr>'
  table += '<td><b>Address</b></td>'
  table += '<td>' + row.Address + '<br>' + city_row.City + ', ON<br>' + row.Zip.slice(0, 3) + ' ' + row.Zip.slice(3, 6) + '</td>' 
  table += '</tr>' 

  table += '<tr>'
  table += '<td><b>Building Type</b></td>'
  table += '<td>' + operation_type_row.operation_type + '</td>'
  table += '</tr>' 

  table += '<tr>'
  table += '<td><b>Floor Area</b></td>'
  table += '<td>' + comma_format(row.tot_floor_area_ft2) + ' sqft</td>' //d3.round(row.tot_floor_area_ft2, 0) + ' sqft</td>'
  table += '</tr>' 

  table += '<tr>'
  table += '<td><b>Energy Consumption</b></td>'
  table += '<td>' + d3.round(row.en_intensity_ekWh_sqft, 1) + ' ekWh/sqft</td>'
  table += '</tr>' 

  table += '<tr>'
  table += '<td><b>Median energy consumption for this type of building</b></td>'
  table += '<td>' + d3.round(operation_type_row.median_en_intensity_ekWh_sqft, 1) + ' ekWh/sqft</td>'
  table += '</tr>' 

  table += '</table></div>'
  return table
};

function get_pct_rank(row, operation_type_row) {
  var span = '<table>'; 
  span += '<tr><td class="big-text">' + '#' + comma_format(row.op_type_rank) + ' of ' + comma_format(operation_type_row.n_buildings) + '</td></tr>'
  span += '<tr><td class="small-text">energy efficiency ranked against the ' + comma_format(operation_type_row.n_buildings) + ' other buildings of this type in Ontario.</td></tr>'
  span += '</table>'
  return span
};

function get_dists(Master) {
  var dists = {};
  for (var i = Master.length - 1; i >= 0; i--) {
    if ( !dists.hasOwnProperty(Master[i].dim_operation_type) ) {
      dists[Master[i].dim_operation_type] = [Master[i].en_intensity_ekWh_sqft];
    } else {
      dists[Master[i].dim_operation_type].push(1.0*Master[i].en_intensity_ekWh_sqft);
    }
  };
  return dists
};

function plot_hist(values, one_en_intensity_ekWh_sqft, div_tag) {
  // A formatter for counts.
  var formatCount = d3.format(",.0f");

  var margin = {top: 10, right: 30, bottom: 50, left: 50},
      width = 275 - margin.left - margin.right, // 800 was 960
      height = 180 - margin.top - margin.bottom;

      var x = d3.scale.linear()
    .domain([0, 100.]) //100., d3.max(values)])
.range([0, width]);

  // Generate a histogram using twenty uniformly-spaced bins.
  var data = d3.layout.histogram()
  .bins(x.ticks(20))
  (values);

  var y = d3.scale.linear()
  .domain([0, d3.max(data, function(d) { return d.y; })])
  .range([height, 0]);

  var xAxis = d3.svg.axis()
  .scale(x)
  .ticks(6)
  .orient("bottom");

  var yAxis = d3.svg.axis()
  .scale(y)
  .ticks(4)
  .orient("left");

  var svg = d3.select(div_tag).append("svg")
  .attr("width", width + margin.left + margin.right)
  .attr("height", height + margin.top + margin.bottom)
  .append("g")
  .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  // Add an x-axis label.
  svg.append("text")
  .attr("class", "x label")
  .attr("text-anchor", "end")
  .attr("x", width)
  .attr("y", height + 30)
  .text("Energy Consumption (ekWh/sqft)");

  // Add a y-axis label.
  svg.append("text")
  .attr("class", "y label")
  .attr("text-anchor", "end")
  .attr("y", -33)
  .attr("x", 6)
    //.attr("dy", ".75em")
    .attr("transform", "rotate(-90)")
    .text("# of Buildings");

    var bar = svg.selectAll(".bar")
    .data(data)
    .enter().append("g")
    .attr("class", "bar")
    .attr("transform", function(d) { return "translate(" + x(d.x) + "," + y(d.y) + ")"; });

    bar.append("rect")
    .attr("x", 1)
    .attr("width", x(data[0].dx) - 1)
    .attr("height", function(d) { return height - y(d.y); });

    svg.append("g")
    .attr("class", "x axis")
    .attr("transform", "translate(0," + height + ")")
    .call(xAxis);

    svg.append("g")
    .attr("class", "y axis")
    .call(yAxis);

  svg.append("line")          // attach a line
    .style("stroke", "red")  // colour the line
    .attr('stroke-width', 3)
    .attr("x1", x(one_en_intensity_ekWh_sqft))     // x position of the first end of the line
    .attr("y1", y(0))      // y position of the first end of the line
    .attr("x2", x(one_en_intensity_ekWh_sqft))     // x position of the second end of the line
    .attr("y2", 0);
  };

  </script>

  <body>
    <div id='container'>
      <h1 id="title">Public Building Energy Consumption in Ontario</h1>

      <div id="intro">
        <p> This page allows you to explore the energy consumption of public buildings in Ontario. It is intended to highlight the best and worst performing buildings to help organizations identify good candidates for retrofit. It is also for individuals to see how the public buildings near them compare to others in Ontario. </p>

        <p> To get started, start typing the name of an organization or building type in the search bar and select the one you want. Then select the buildings you are interested in and individual energy reports will appear. The energy efficiency of each building is ranked in two ways: compared to buildings of the same type (e.g. Community Centres) and compared to buildings managed by the same organization. </p>
        <p> To get started, choose to search by building type or organization name: </p>
      </div>
      <div id='text-and-radio'>
        <div id="search-by"> Search by: </div> 
        <div id="radio">
          <input type="radio" id="radio1" name="radio"><label for="radio1">Organization</label>
          <input type="radio" id="radio2" name="radio" checked="checked"><label for="radio2">Building Type</label>
        </div>
      </div>
      <div class="ui-widget" id="search-div">
        <input id="search-bar" class="default-value" onkeydown="if (event.keyCode == 13) document.getElementById('go-button').click()" value="Enter an organization name here...">
        <input id="go-button" type="submit" value="Go">
      </div>
      <div id="map-and-list">
        <div id="results-container">
          <table id="results-table" class="display" cellspacing="0">
            <thead>
              <tr> <th>Organization<br>Rank</th> <th>Operation<br>Type Rank</th> <th>Building Name</th> </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div id="map_canvas"></div>
      </div>
    </div>
  </body>

  <footer>
    <div id="footnote">

      <p>Note: ekWh stands for equivalent kilowatt hours, which includes heating, cooling and other electrical energy use. sqft stands for square feet of floor area. </p>

      <p>This work uses utility data for 2012, and was made possible by the Government of Ontario's <a class="my-link" href="https://www.ontario.ca/open-data">Open Data Catalogue</a>. </p>

      <p>For the raw data this app uses, <a class='my-link' href="https://www.ontario.ca/data/energy-use-and-greenhouse-gas-emissions-broader-public-sector">click here</a>.</p>

      <p>Created by <a class='my-link' href="http://stephenmcmurtry.org/">Stephen McMurtry</a>, &copy; 2015. </p>

    </div>
  </footer>

  </html>
